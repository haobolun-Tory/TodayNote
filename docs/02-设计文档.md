# TodayNote 博客系统（MVP）设计文档

## 1. 技术选型

### 1.1 前端（Vue 3）
- Vue 3 + Vite
- Vue Router（路由）
- Pinia（状态管理）
- Axios（HTTP）
- Markdown 渲染：`markdown-it`（开启 XSS 防护策略）

### 1.2 后端（Java 21）
- Spring Boot 3.5.x（当前工程已使用 3.5.11）
- Spring Web（REST API）
- Validation（参数校验）
- MyBatis-Plus（数据访问，当前工程已引入）
- MySQL 8.x（本地）
- 认证：JWT（建议引入 `jjwt` 或 Spring Security 方案；MVP 可先自实现过滤器）
- 密码加密：BCrypt（建议引入 `spring-security-crypto` 或 Spring Security Starter）

说明：为了保持简单，MVP 建议先做“单体 REST API + JWT”。

## 2. 系统模块划分

### 2.1 前端页面（MVP）
- `/`：首页文章列表（分页）
- `/post/:id`：文章详情
- `/search?q=`：搜索结果
- `/u/:username`：作者主页
- `/login`：登录
- `/register`：注册
- `/editor`：写文章（新建）
- `/editor/:id`：编辑文章
- `/me/posts`：我的文章管理（草稿/已发布）

### 2.2 后端模块（建议包结构）
- `com.todaynote.common`：统一响应、异常、工具
- `com.todaynote.auth`：登录/注册/JWT
- `com.todaynote.user`：用户与个人信息
- `com.todaynote.post`：文章领域（含标签）
- `com.todaynote.search`：简单搜索（可在 post 中实现）

分层：
- Controller：DTO 入参/出参 + 校验
- Service：业务规则（权限、状态流转）
- Mapper（MyBatis-Plus）：数据库访问

## 3. 核心数据模型（Domain）

### 3.1 用户 User
- id
- username（唯一）
- password_hash
- nickname
- bio（简介）
- avatar_url
- role（USER/ADMIN）
- created_at / updated_at

### 3.2 文章 Post
- id
- author_id
- title
- summary
- content_md
- content_html（可选：若选择后端渲染）
- status（DRAFT/PUBLISHED）
- category_id（可选）
- published_at（可空）
- created_at / updated_at / deleted_at

### 3.3 标签 Tag & 关联 PostTag
- tag：id, name（唯一）
- post_tag：post_id, tag_id（联合唯一）

（分类 Category 可先不实现或先做简单表：id, name）

## 4. 数据库表设计（MySQL）

### 4.1 `user`
- `id` BIGINT PK
- `username` VARCHAR(50) UNIQUE NOT NULL
- `password_hash` VARCHAR(100) NOT NULL
- `nickname` VARCHAR(50)
- `bio` VARCHAR(200)
- `avatar_url` VARCHAR(255)
- `role` VARCHAR(20) NOT NULL DEFAULT 'USER'
- `created_at` DATETIME NOT NULL
- `updated_at` DATETIME NOT NULL

索引：`uk_user_username(username)`

### 4.2 `post`
- `id` BIGINT PK
- `author_id` BIGINT NOT NULL
- `title` VARCHAR(200) NOT NULL
- `summary` VARCHAR(500)
- `content_md` MEDIUMTEXT NOT NULL
- `status` VARCHAR(20) NOT NULL  -- DRAFT/PUBLISHED
- `category_id` BIGINT NULL
- `published_at` DATETIME NULL
- `created_at` DATETIME NOT NULL
- `updated_at` DATETIME NOT NULL
- `deleted_at` DATETIME NULL

索引：
- `idx_post_author(author_id, created_at)`
- `idx_post_status_published(status, published_at)`
- `idx_post_title(title)`（MVP 搜索用）

### 4.3 `tag`
- `id` BIGINT PK
- `name` VARCHAR(50) UNIQUE NOT NULL

### 4.4 `post_tag`
- `post_id` BIGINT NOT NULL
- `tag_id` BIGINT NOT NULL
- PK：(`post_id`, `tag_id`)

外键（可选）：MVP 可不强制外键，靠应用层保证。

## 5. REST API 设计（MVP）

统一约定：
- Base URL：`/api`
- 响应格式：
  - `code`：0 表示成功，非 0 表示错误
  - `message`：错误信息
  - `data`：业务数据

### 5.1 认证
- `POST /api/auth/register`
  - req：`{ username, password, nickname? }`
  - resp：`{ token, user }`
- `POST /api/auth/login`
  - req：`{ username, password }`
  - resp：`{ token, user }`
- `GET /api/auth/me`
  - header：`Authorization: Bearer <token>`
  - resp：当前用户信息

### 5.2 文章
- `POST /api/posts`（登录）创建草稿
- `PUT /api/posts/{id}`（登录）更新（仅作者）
- `POST /api/posts/{id}/publish`（登录）发布
- `POST /api/posts/{id}/unpublish`（登录）取消发布
- `DELETE /api/posts/{id}`（登录）删除（软删）

- `GET /api/posts` 公开列表
  - query：`page,size,tag?,author?,q?`
- `GET /api/posts/{id}` 文章详情
  - 若文章为草稿，仅作者可访问

### 5.3 标签
- `GET /api/tags` 标签列表（可用于写作页选择）
- `POST /api/tags`（登录，可选）创建标签（或由写作时自动创建）

### 5.4 用户
- `GET /api/users/{username}` 作者信息
- `GET /api/users/{username}/posts` 作者已发布文章

## 6. 关键业务规则
- 发布规则：
  - `status=DRAFT` 才允许 publish
  - 发布时设置 `published_at=now()`
- 取消发布：
  - 仅已发布文章允许
  - `status=PUBLISHED -> DRAFT`，`published_at=null`
- 访问控制：
  - `GET /posts/{id}`：
    - PUBLISHED：公开
    - DRAFT：仅作者

## 7. 前端交互与状态
- 登录后：token 存储在 `localStorage`（MVP）
- Axios 拦截器：自动带上 `Authorization`
- 路由守卫：`/editor`、`/me/posts` 需要登录

## 8. 错误码建议
- `0`：成功
- `40001`：参数错误
- `40100`：未登录/Token 无效
- `40300`：无权限
- `40400`：资源不存在
- `50000`：系统错误

## 9. 后端实现建议（贴合当前工程）
- 使用 MyBatis-Plus 的 `BaseMapper` + `ServiceImpl`
- 开启逻辑删除：可用 MyBatis-Plus 逻辑删除字段（或自行用 `deleted_at`）
- 全局异常处理：`@RestControllerAdvice`
- 统一响应：`ApiResponse<T>`

